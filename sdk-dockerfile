FROM ubuntu:18.04
EXPOSE 9080 9081
ENV HOME=/home/dash
ENV GAEDATA=/home/dash/.gaedata
ENV LOG_LEVEL="info"
RUN apt-get update && \
    apt-get -y -q --force-yes install \
    python2.7 \
    less \
    vim \
    curl \
    python-pip \
    apt-transport-https \
    ca-certificates \
    gnupg2
RUN echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
ADD https://packages.cloud.google.com/apt/doc/apt-key.gpg /tmp/apt-key.gpg
RUN apt-key --keyring /usr/share/keyrings/cloud.google.gpg add /tmp/apt-key.gpg && rm /tmp/apt-key.gpg
RUN apt-get update && \
    apt-get -y -q --force-yes install \
    google-cloud-sdk=337.0.0-0\
    google-cloud-sdk-app-engine-python=198.0.0-0 \
    google-cloud-sdk-app-engine-python-extras=198.0.0-0 \
    google-cloud-sdk-datastore-emulator=198.0.0-0
COPY sdk-requirements.txt /tmp/requirements.txt
RUN pip install -r /tmp/requirements.txt && rm /tmp/requirements.txt
RUN mkdir $GAEDATA
COPY static/favicon.ico $HOME/dash-live/static/
COPY static/fonts/* $HOME/dash-live/static/fonts/
COPY static/img/* $HOME/dash-live/static/img/
COPY static/js/prod/* $HOME/dash-live/static/js/prod/
COPY static/js/dev/* $HOME/dash-live/static/js/dev/
COPY static/js/*.js $HOME/dash-live/static/js/
COPY lib/*.py $HOME/dash-live/lib/
COPY *.py $HOME/dash-live/
COPY *.yaml $HOME/dash-live/
COPY templates/*.mpd $HOME/dash-live/templates/
COPY templates/*.html $HOME/dash-live/templates/
COPY templates/drm/*.xml $HOME/dash-live/templates/drm/
COPY templates/events/*.xml $HOME/dash-live/templates/events/
COPY templates/segment/*.xml $HOME/dash-live/templates/segment/
COPY static/css/* $HOME/dash-live/static/css/
COPY runserver.sh $HOME/dash-live/
COPY src/drm/*.py $HOME/dash-live/src/drm/
COPY src/mpeg/*.py $HOME/dash-live/src/mpeg/
COPY src/mpeg/dash/*.py $HOME/dash-live/src/mpeg/dash/
COPY src/scte35/*.py $HOME/dash-live/src/scte35/
COPY src/server/*.py $HOME/dash-live/src/server/
COPY src/server/events/*.py $HOME/dash-live/src/server/events/
COPY src/server/requesthandler/*.py $HOME/dash-live/src/server/requesthandler/
COPY src/templates/*.py $HOME/dash-live/src/templates/
COPY src/testcase/*.py $HOME/dash-live/src/testcase/
COPY src/utils/*.py $HOME/dash-live/src/utils/
COPY src/utils/fio/*.py $HOME/dash-live/src/utils/fio/
ADD https://raw.githubusercontent.com/GoogleCloudPlatform/python-docs-samples/6f5f3bcb81779679a24e0964a6c57c0c7deabfac/appengine/standard/localtesting/runner.py $HOME/dash-live/runner.py
WORKDIR /home/dash/dash-live
RUN python ./gen-settings.py
RUN python -m lesscpy static/css -o static/css/
ENTRYPOINT ["/home/dash/dash-live/runserver.sh"]
